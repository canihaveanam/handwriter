<!DOCTYPE html>
<html>
<head>
    <title>æ‰‹å†™å¤§ç—…å†</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { display: flex; gap: 20px; max-width: 1400px; margin: 0 auto; }
        .control-panel { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .preview-panel { flex: 2; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        input, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        textarea { height: 120px; resize: vertical; }
        .slider-container { display: flex; align-items: center; gap: 10px; }
        .slider-container input[type="range"] { flex: 1; }
        .slider-value { min-width: 40px; font-weight: bold; }
        button { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #005a87; }
        .preview-frame { width: 100%; height: 600px; border: 1px solid #ddd; border-radius: 4px; }

        .tab-buttons { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 10px; }
        .tab-button { padding: 10px 20px; cursor: pointer; border: none; background: #eee; border-radius: 4px 4px 0 0; }
        .tab-button.active { background: #007cba; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>

<div class="container">
        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->

    <div class="control-panel">
        <h2>æ‰‹å†™å¤§ç—…å†</h2>

        <!-- æ ‡ç­¾æŒ‰é’® -->
        <div class="tab-buttons">
            <button class="tab-button active" onclick="switchTab('basic')">åŸºæœ¬ä¿¡æ¯</button>
            <button class="tab-button" onclick="switchTab('text')">æ–‡æœ¬è®¾ç½®</button>
            <button class="tab-button" onclick="switchTab('effects')">æ‰‹å†™æ•ˆæœ</button>
            <button class="tab-button" onclick="switchTab('fields')">å­—æ®µä½ç½®</button>
        </div>

        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div id="basic" class="tab-content active">
            <div class="form-group">
                <label>ç—…åŒºï¼š</label>
                <input type="text" id="ç—…åŒº">
                <label>å§“åï¼š</label>
                <input type="text" id="å§“å">
                <label>åºŠå·ï¼š</label>
                <input type="text" id="åºŠå·">
                <label>ä½é™¢å·ï¼š</label>
                <input type="text" id="ä½é™¢å·">
            </div>

            <div class="form-group">
                <label>æ–‡æœ¬å†…å®¹ï¼š</label>
                <textarea id="text_content" placeholder="è¯·è¾“å…¥æ–‡æœ¬å†…å®¹"></textarea>
            </div>
        </div>

        <!-- æ–‡æœ¬è®¾ç½® -->
        <div id="text" class="tab-content">
            <div class="form-group">
                <label>å­—ä½“å¤§å°ï¼š</label>
                <div class="slider-container">
                    <input type="range" id="font_size" min="8" max="30" value="15">
                    <span id="font_size_value">15</span>
                </div>
            </div>

            <div class="form-group">
                <label>èµ·å§‹ X åæ ‡ï¼š</label>
                <div class="slider-container">
                    <input type="range" id="start_x" min="0" max="500" value="64">
                    <span id="start_x_value">64</span>
                </div>
            </div>

            <div class="form-group">
                <label>èµ·å§‹ Y åæ ‡ï¼š</label>
                <div class="slider-container">
                    <input type="range" id="start_y" min="0" max="800" value="661">
                    <span id="start_y_value">661</span>
                </div>
            </div>

            <div class="form-group">
                <label>è¡Œé—´è·ï¼š</label>
                <div class="slider-container">
                    <input type="range" id="line_height" min="10" max="50" value="30">
                    <span id="line_height_value">30</span>
                </div>
            </div>
        </div>

        <!-- æ‰‹å†™æ•ˆæœè®¾ç½® -->
        <div id="effects" class="tab-content">
            <div class="form-group">
                <label>è¡ŒæŠ–åŠ¨ï¼ˆä¸Šä¸‹æµ®åŠ¨ï¼‰ï¼š</label>
                <div class="slider-container">
                    <input type="range" id="line_jitter" min="0" max="5" value="3">
                    <span id="line_jitter_value">3</span>
                </div>
            </div>

            <div class="form-group">
                <label>å­—æŠ–åŠ¨ï¼ˆå·¦å³æµ®åŠ¨ï¼‰ï¼š</label>
                <div class="slider-container">
                    <input type="range" id="char_jitter" min="0" max="5" value="2">
                    <span id="char_jitter_value">2</span>
                </div>
            </div>
        </div>

        <!-- å­—æ®µä½ç½® -->
        <div id="fields" class="tab-content">
            <div class="form-group">
                <label>ç—…åŒºä½ç½®</label>
                X:<input type="number" id="ç—…åŒº_x" value="110"> Y:<input type="number" id="ç—…åŒº_y" value="694">
            </div>
            <div class="form-group">
                <label>å§“åä½ç½®</label>
                X:<input type="number" id="å§“å_x" value="190"> Y:<input type="number" id="å§“å_y" value="694">
            </div>
            <div class="form-group">
                <label>åºŠå·ä½ç½®</label>
                X:<input type="number" id="åºŠå·_x" value="280"> Y:<input type="number" id="åºŠå·_y" value="694">
            </div>
            <div class="form-group">
                <label>ä½é™¢å·ä½ç½®</label>
                X:<input type="number" id="ä½é™¢å·_x" value="450"> Y:<input type="number" id="ä½é™¢å·_y" value="694">
            </div>
        </div>

<button onclick="generatePreview()">é¢„è§ˆPDF</button>
<button id="downloadAllImages" onclick="downloadAllImages()" disabled>ä¸‹è½½æ‰€æœ‰é¡µé¢å›¾ç‰‡(ZIP)</button>
        <button onclick="generatePDF()" style="background:#28a745;">ç”Ÿæˆ PDF</button>

        <div id="downloadLink" style="margin-top:10px;"></div>
    </div>

    <!-- å³ä¾§é¢„è§ˆ -->
    <div class="preview-panel">
        <h2>å®æ—¶é¢„è§ˆ</h2>
        <iframe class="preview-frame" id="previewFrame"></iframe>
    </div>

</div>

<script>
function switchTab(id){
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    event.target.classList.add('active');
}

function getSettings(){
    return {
        font_size: Number(font_size.value),
        start_x: Number(start_x.value),
        start_y: Number(start_y.value),
        line_height: Number(line_height.value),
        line_jitter: Number(line_jitter.value),
        char_jitter: Number(char_jitter.value),
        fields:{
            'ç—…åŒº':{x:Number(ç—…åŒº_x.value), y:Number(ç—…åŒº_y.value)},
            'å§“å':{x:Number(å§“å_x.value), y:Number(å§“å_y.value)},
            'åºŠå·':{x:Number(åºŠå·_x.value), y:Number(åºŠå·_y.value)},
            'ä½é™¢å·':{x:Number(ä½é™¢å·_x.value), y:Number(ä½é™¢å·_y.value)}
        }
    };
}

function getFields(){
    return {
        'ç—…åŒº': ç—…åŒº.value,
        'å§“å': å§“å.value,
        'åºŠå·': åºŠå·.value,
        'ä½é™¢å·': ä½é™¢å·.value
    };
}

let currentPdfFilename = null;

async function generatePreview(){
    const text = text_content.value;
    if(!text){ alert("è¯·è¾“å…¥æ–‡æœ¬å†…å®¹"); return; }

    const res = await fetch('/preview',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({text, fields:getFields(), settings:getSettings()})
    });

    const data = await res.json();
    if(data.success){
        currentPdfFilename = data.preview_url.split('/').pop();
        previewFrame.src = data.preview_url + "?t=" + Date.now();
        
        // å¯ç”¨ä¸‹è½½æ‰€æœ‰å›¾ç‰‡æŒ‰é’®
        document.getElementById('downloadAllImages').disabled = false;
    }
}

// ä¸‹è½½æ‰€æœ‰é¡µé¢å›¾ç‰‡
async function downloadAllImages(){
    if(!currentPdfFilename){
        alert("è¯·å…ˆé¢„è§ˆç”ŸæˆPDF");
        return;
    }

    const button = document.getElementById('downloadAllImages');
    const originalText = button.textContent;
    
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        button.textContent = 'æ‰“åŒ…ä¸­...';
        button.disabled = true;
        
        const res = await fetch(`/download_images/${currentPdfFilename}`);
        
        if(!res.ok){
            throw new Error('ä¸‹è½½å¤±è´¥: ' + res.status);
        }
        
        const blob = await res.blob();
        
        if(blob.size === 0){
            throw new Error('ç”Ÿæˆçš„æ–‡ä»¶ä¸ºç©º');
        }
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `æ‰‹å†™æ–‡æ¡£_æ‰€æœ‰é¡µé¢.zip`;
        
        document.body.appendChild(a);
        a.click();
        
        // æ¸…ç†èµ„æº
        setTimeout(() => {
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }, 100);
        
    } catch(error) {
        console.error('ä¸‹è½½å¤±è´¥:', error);
        alert('ä¸‹è½½å¤±è´¥: ' + error.message);
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        button.textContent = originalText;
        button.disabled = false;
    }
}


async function generatePDF(){
    const text = text_content.value;
    if(!text){ alert("è¯·è¾“å…¥æ–‡æœ¬å†…å®¹"); return; }

    const res = await fetch('/generate',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({text, fields:getFields(), settings:getSettings()})
    });

    const data = await res.json();
    if(data.success){
        downloadLink.innerHTML = `<a href="${data.download_url}" target="_blank">ğŸ“¥ ä¸‹è½½ PDF</a>`;
    }
}
// ---------- è‡ªåŠ¨ä¿å­˜ & æ¢å¤åŠŸèƒ½ ----------

// æ‰€æœ‰éœ€è¦ç›‘å¬å˜åŒ–çš„è¾“å…¥ç±»å‹
const INPUT_SELECTOR = 'input, textarea';

// ä¿å­˜åˆ° localStorage çš„é”®å
const STORAGE_KEY = "medical_form_data";

// ==== è‡ªåŠ¨ä¿å­˜ ====
function autoSave() {
    const allInputs = document.querySelectorAll(INPUT_SELECTOR);

    let data = {};
    allInputs.forEach(el => {
        if (el.id) data[el.id] = el.value;
    });

    // ç‰¹æ®Šä¿å­˜ï¼šæ»‘å—æ•°å€¼æ–‡æœ¬ï¼ˆå› ä¸ºå®ƒä»¬ä¸æ˜¯è¾“å…¥æ¡†ï¼‰
    data['font_size_value'] = font_size_value.innerText;
    data['start_x_value'] = start_x_value.innerText;
    data['start_y_value'] = start_y_value.innerText;
    data['line_height_value'] = line_height_value.innerText;
    data['line_jitter_value'] = line_jitter_value.innerText;
    data['char_jitter_value'] = char_jitter_value.innerText;

    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

// ==== æ¢å¤æ•°æ® ====
function restoreData() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) return;

    const data = JSON.parse(saved);

    Object.keys(data).forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.value = data[id];

            // å¦‚æœæ˜¯æ»‘å—ï¼Œéœ€è¦åŒæ­¥æ˜¾ç¤ºæ•°å€¼
            if (el.type === "range") {
                document.getElementById(id + "_value").innerText = data[id];
            }
        }
    });
}

// é¡µé¢åŠ è½½æ—¶æ¢å¤
window.addEventListener("DOMContentLoaded", restoreData);

// æ‰€æœ‰è¾“å…¥å˜åŒ–æ—¶è‡ªåŠ¨ä¿å­˜
document.addEventListener("input", autoSave);
</script>

</body>
</html>